#!/bin/sh

#=============== CUSTOMIZATION ==================

SW_TITLE="xtracer"
SW_PACKAGE="xtracer"
SW_DESCRIPTION="Photorealistic Renderer"

MAN_SECTION=""

PATH_PREFIX=/usr/local

FLAGS_XTR="-fopenmp -Wall -Wno-unknown-pragmas -ffast-math -funsafe-math-optimizations"
DEP_DLIB="-lX11 -lGL -lglut -lGLEW"

#================================================

if [ -z "$MAN_SECTION" ]; then MAN_SECTION="1"; fi

PATH_PREFIX="`echo $PATH_PREFIX | sed -e 's/ /_/g'`"

SW_TITLE="`echo $SW_TITLE | sed -e 's/ /_/g'`"
SW_PACKAGE="`echo $SW_PACKAGE | sed -e 's/ /_/g'`"
SW_SYMID="`echo $SW_TITLE | tr '[:lower:]' '[:upper:]'`"
SW_VERSION="`git describe --long`"

# Options
FLAG_DBGSYM=no
FLAG_OPTSPD=yes

for arg in "$@"
do
	case "$arg" in
		--prefix=*)
			value = `echo $arg | sed 's/--prefix = //'`
			PREFIX = ${value:-$prefix}
			;;

        --enable-opt)
			FLAG_OPTSPD=yes
			;;
        --disable-opt)
			FLAG_OPTSPD=no
			;;

		--enable-debug)
			FLAG_DBGSYM=yes
			;;
		--disable-debug)
			FLAG_DBGSYM=no
			;;

		--help)
			echo 'Usage: ./configure [options]'
			echo 'Options:'
			echo '  --prefix=<path>: installation path (default: /usr/local)'
			echo '  --enable-opt: Enable speed optimizations (default)'
			echo '  --disable-opt: Disable speed optimizations'
			echo '  --enable-debug: Include debugging symbols'
			echo '  --disable-debug: Ommit debugging symbols (default)'
			echo 'All invalid options are silently ignored'
			exit 0
			;;
	esac
done

echo "Configuring $SW_PACKAGE v$SW_VERSION.."
echo "- installation path prefix: $PATH_PREFIX"
echo "- optimize for speed: $FLAG_OPTSPD"
echo "- include debugging symbols: $FLAG_DBGSYM"

echo "Creating makefile..."
echo "# $SW_PACKAGE" > Makefile
echo "# Auto-generated makefile" >> Makefile
echo >> Makefile

echo "SW_SYMID   = $SW_SYMID" >> Makefile
echo "SW_TITLE   = $SW_TITLE" >> Makefile
echo "SW_PACKAGE = $SW_PACKAGE" >> Makefile
echo "SW_VERSION = $SW_VERSION" >> Makefile
echo >> Makefile

echo "PATH_PREFIX = $PATH_PREFIX" >> Makefile
echo >> Makefile

echo "MAN_SECTION = $MAN_SECTION" >> Makefile
echo >> Makefile

if [ "$DBGSPD" = 'yes' ]; then
	echo 'FLAGS_DBG = -g' >> Makefile
fi

if [ "$FLAG_OPTSPD" = 'yes' ]; then
	echo 'FLAGS_OPT = -O3' >> Makefile
fi

echo >> Makefile

echo 'EXT_STATIC  = a'  >> Makefile
echo 'EXT_DYNAMIC = so' >> Makefile

echo >> Makefile

echo "DEP_DLIB = $DEP_DLIB" >> Makefile
echo >> Makefile

echo "FLAGS_XTR = $FLAGS_XTR" >> Makefile
echo >> Makefile

cat Makefile.common.in >> Makefile
cat Makefile.xtcore.in >> Makefile
cat Makefile.xtfcli.in >> Makefile
cat Makefile.xtfgui.in >> Makefile
cat Makefile.test.in   >> Makefile

echo 'Creating pkg-config file ...'

echo "Name: $SW_TITLE" > $SW_TITLE.pc
echo "Description: $SW_DESCRIPTION" >> $SW_TITLE.pc
echo "Version: $SW_VERSION" >> $SW_TITLE.pc
echo "Cflags: -I$PATH_PREFIX/include/$SW_TITLE" >> $SW_TITLE.pc
echo "Libs: -L$PATH_PREFIX/lib -l$SW_TITLE" >> $SW_TITLE.pc
